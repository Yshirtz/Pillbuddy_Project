<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>PillBuddy</title>
    
    <style>
      @font-face {
        font-family: "Harlow Solid Italic";
        src: url("./fonts/HarlowSolidItalic.ttf") format("truetype"),
             url("/static/fonts/HarlowSolidItalic.ttf") format("truetype"),
             url("fonts/HarlowSolidItalic.ttf") format("truetype");
        font-weight: normal;
        font-style: italic;
        font-display: swap;
      }
      :root {
        --primary-color: #4a90e2;
        --bg-color: #f5f7fa;
        --text-color: #333;
        --white: #ffffff;
      }

      * {
        box-sizing: border-box;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui,
          Roboto, sans-serif;
        background-color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }

      #app-container {
        width: 100%;
        max-width: 420px;
        height: 100%;
        max-height: 900px;
        background-color: var(--white);
        position: relative;
        display: flex;
        flex-direction: column;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      header {
        padding: 14px;
        text-align: center;
        font-weight: normal;
        font-size: 1.5rem;
        font-family: "Harlow Solid Italic", "HarlowSolidItalic", serif;
        border-bottom: none;
        background: var(--white);
        z-index: 10;
        font-style: italic;
        /* í°íŠ¸ ê°•ì œ ì ìš© */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        margin-bottom: 0;
      }

      .screen {
        flex: 1;
        display: none;
        flex-direction: column;
        position: absolute;
        top: 50px;
        bottom: 0;
        width: 100%;
        background: var(--white);
      }

      .screen.active {
        display: flex;
      }

      #screen-1 .content-area,
      #screen-3 .content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px;
        text-align: center;
      }

      #screen-1 .content-area {
        background-color: #f0f8ff;
      }

      #screen-1 .start-button {
        margin-top: 40px;
        background-color: var(--primary-color);
        color: var(--white);
        padding: 16px 32px;
        border-radius: 30px;
        font-size: 1.2rem;
        cursor: pointer;
        font-weight: bold;
      }

      #screen-2 .policy-content {
        display: none;
      }

      .split-btn-container {
        flex: 1;
        display: flex;
      }

      .split-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
      }

      .btn-refuse {
        background-color: #ff6b6b;
        color: white;
      }

      .btn-agree {
        background-color: #7d9bff;
        color: white;
      }

      #screen-3 .content-area {
        background-color: #f0f8ff;
        cursor: pointer;
      }

      .speed-display {
        font-size: 3rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 12px;
      }

      .speed-hint {
        color: #666;
        font-size: 1rem;
      }

      .speed-confirm {
        background-color: var(--primary-color);
        color: white;
        text-align: center;
        padding: 60px 80px 100px 80px;  /* ìœ„ìª½ ì¤„ì´ê³  ì•„ë˜ìª½ ëŠ˜ë¦¬ê¸° */
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;  /* ë˜ëŠ” flex-startë¡œ ë” ìœ„ë¡œ */
        flex-direction: column;
      }

      #screen-4 .camera-view {
        flex: 1;
        background-color: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 16px;
        position: relative;
      }

      #camera-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 18px;
        background-color: #111;
      }

      .camera-guide {
        position: absolute;
        width: 200px;
        height: 200px;
        border: 2px dashed rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        text-align: center;
        pointer-events: none;
      }

      .shutter-area {
        height: 140px;
        background-color: #111;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .shutter-btn {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: white;
        border: 6px solid #ccc;
      }

      #screen-5 .loading-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 24px;
        gap: 16px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 6px solid #f3f3f3;
        border-top: 6px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #screen-6 {
        position: relative;
        top: 0;
      }

      .result-container {
        flex: 1;
        padding: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 16px;
      }

      .pill-img-placeholder {
        width: 120px;
        height: 120px;
        background-color: #ddd;
        border-radius: 50%;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 3rem;
      }

      .result-text {
        width: 100%;
        background-color: #f9f9f9;
        padding: 18px;
        border-radius: 14px;
        font-size: 1rem;
        line-height: 1.5;
        text-align: left;
        min-height: 140px;
        display: none;
      }

      .result-meta {
        width: 100%;
        font-size: 0.95rem;
        color: #555;
        display: none;
      }

      .followup-card {
        display: none;
      }

      #followup-layer {
        display: none;
      }

      /* ê°€ìš´ë° ë²„íŠ¼ - ë‹¤ì‹œ ë“£ê¸° */
      #replay-button {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        transform: none;
        z-index: 20;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 0;
        padding: 16px 32px;
        width: 100%;
        height: 65%;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ì¢Œì¸¡ í•˜ë‹¨ ë²„íŠ¼ - ì²˜ìŒë¶€í„° */
      #reset-button {
        position: absolute;
        top: 65%;
        bottom: 0;
        left: 0;
        z-index: 20;
        background-color: #ff6b6b;
        color: white;
        border: none;
        border-radius: 0;
        padding: 16px 24px;
        width: 50%;
        height: auto;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* ìš°ì¸¡ í•˜ë‹¨ ë²„íŠ¼ - ì¶”ê°€ ì§ˆë¬¸ */
      #followup-button {
        position: absolute;
        top: 65%;
        bottom: 0;
        right: 0;
        z-index: 20;
        background-color: #7d9bff;
        color: white;
        border: none;
        border-radius: 0;
        padding: 16px 24px;
        width: 50%;
        height: auto;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .toast {
        position: absolute;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        opacity: 0;
        font-size: 0.9rem;
        transition: opacity 0.2s ease;
      }

      .toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div id="app-container">
      <header>PillBuddy</header>

      <div id="screen-1" class="screen active">
        <div class="content-area" id="start-touch-area">
          <h1>í•„ë²„ë””ì™€ í•¨ê»˜<br />ì•Œì•½ì„ í™•ì¸í•´ë³¼ê¹Œìš”?</h1>
          <p>í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì•ˆë‚´ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</p>
          <div class="start-button">ì‹œì‘í•˜ê¸°</div>
        </div>
      </div>

      <div id="screen-2" class="screen">
        <div class="policy-content">
          <p>
            ì•ˆë…•í•˜ì„¸ìš”, í•„ë²„ë””ì…ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ëŠ” AI ë¶„ì„ ë„êµ¬ë¡œ, ê²°ê³¼ê°€
            ë¶€ì •í™•í•  ìˆ˜ ìˆì–´ ì˜í•™ì  íŒë‹¨ì„ ëŒ€ì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ
            í™œìš©í•˜ì‹œê³ , ë” ì „ë¬¸ì ì¸ ë‚´ìš©ì€ ë°˜ë“œì‹œ ì˜ì‚¬ë‚˜ ì•½ì‚¬ì™€ ìƒë‹´í•´ ì£¼ì„¸ìš”. ì´
            ë‚´ìš©ì— ë™ì˜í•˜ì‹œë©´ í™”ë©´ ì˜¤ë¥¸ìª½, ê±°ì ˆí•˜ì‹œë©´ í™”ë©´ ì™¼ìª½ì„ í„°ì¹˜í•´ì£¼ì„¸ìš”.
          </p>
        </div>
        <div class="split-btn-container">
          <div class="split-btn btn-refuse" id="consent-no">
            <div>ê±°ë¶€</div>
          </div>
          <div class="split-btn btn-agree" id="consent-yes">
            <div>ë™ì˜</div>
          </div>
        </div>
      </div>

      <div id="screen-3" class="screen">
        <div class="content-area" id="speed-screen-touch">
          <div style="font-size: 1.1rem; margin-bottom: 10px">
            ìŒì„± ì¬ìƒ ì†ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
          </div>
          <div class="speed-display" id="speed-text">1.0ë°°ì†</div>
          <div class="speed-hint">
            í™”ë©´ì„ íƒ­í•˜ë©´ ì†ë„ê°€ ë°”ë€Œê³ , ë”ë¸” íƒ­ ë˜ëŠ” ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ í™•ì •í•©ë‹ˆë‹¤.
          </div>
        </div>
        <div class="speed-confirm" id="speed-confirm">
          ë°°ì† ì„¤ì • ì™„ë£Œí•˜ê³  <br /> ì´¬ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™
        </div>
      </div>

      <div id="screen-4" class="screen">
        <div class="camera-view">
          <video id="camera-preview" autoplay playsinline></video>
          <div class="camera-guide">ì•Œì•½ì„ ì´ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
        </div>
        <div class="shutter-area">
          <div class="shutter-btn"></div>
        </div>
      </div>

      <div id="screen-5" class="screen">
        <div class="loading-container">
          <div class="spinner"></div>
          <h2>ë¶„ì„ ì¤‘...</h2>
          <p id="loading-status">ì„œë²„ì— ì´ë¯¸ì§€ë¥¼ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>

      <div id="screen-6" class="screen">
        <div class="result-container">
          <div class="pill-img-placeholder">ğŸ’Š</div>
          <div class="result-meta">
            <div><strong>ì•½ ì´ë¦„:</strong> <span id="result-pill-name">-</span></div>
            <div id="result-subtitle">
              ì„¤ëª…ì„ ë‹¤ì‹œ ë“£ê³  ì‹¶ìœ¼ì‹œë©´, í™”ë©´ ê°€ìš´ë°ì—ì„œ ìœ— ë¶€ë¶„ì‚¬ì´ë¥¼, ì¶”ê°€ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ìš°ì¸¡ í•˜ë‹¨ì„, ë‹¤ë¥¸ ì•½ì„ ì´¬ì˜í•˜ê³  ì‹¶ìœ¼ì‹œë©´ ì¢Œì¸¡ í•˜ë‹¨ë²„íŠ¼ì„ í„°ì¹˜í•´ì£¼ì„¸ìš”ìš”.
            </div>
          </div>
          <div class="result-text" id="result-text">
            ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
          <div class="followup-card">
            <div><strong>ë§ˆì§€ë§‰ ì§ˆë¬¸:</strong></div>
            <div id="followup-question">-</div>
            <div style="margin-top: 10px"><strong>AI ë‹µë³€:</strong></div>
            <div id="followup-answer">-</div>
          </div>
        </div>
        <button id="replay-button">ë‹¤ì‹œ ë“£ê¸°</button>
        <button id="reset-button">ì²˜ìŒë¶€í„°</button>
        <button id="followup-button">ì¶”ê°€ ì§ˆë¬¸</button>
      </div>

      <div class="toast" id="toast"></div>
    </div>

    <script>
      const API_BASE = "";
      const sessionId = crypto.randomUUID();
      const PROMPTS = Object.freeze({
        intro:
          "ì•ˆë…•í•˜ì„¸ìš”. í•„ë²„ë””ì…ë‹ˆë‹¤. í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì•ˆë‚´ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        consent:
          "ì•ˆë…•í•˜ì„¸ìš”, í•„ë²„ë””ì…ë‹ˆë‹¤. ì´ ì„œë¹„ìŠ¤ëŠ” AI ë¶„ì„ ë„êµ¬ë¡œ, ê²°ê³¼ê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆì–´ ì˜í•™ì  íŒë‹¨ì„ ëŒ€ì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì‹œê³ , ë” ì „ë¬¸ì ì¸ ë‚´ìš©ì€ ë°˜ë“œì‹œ ì˜ì‚¬ë‚˜ ì•½ì‚¬ì™€ ìƒë‹´í•´ ì£¼ì„¸ìš”. ì´ ë‚´ìš©ì— ë™ì˜í•˜ì‹œë©´ í™”ë©´ ì˜¤ë¥¸ìª½, ê±°ì ˆí•˜ì‹œë©´ í™”ë©´ ì™¼ìª½ì„ í„°ì¹˜í•´í•´ì£¼ì„¸ìš”.",
        consentDenied:
          "ë™ì˜ë¥¼ ì™„ë£Œí•´ì•¼ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”. ì›í•˜ì‹¤ ë•Œ ë‹¤ì‹œ ì ‘ì†í•´ì£¼ì„¸ìš”.",
        speed:
          "ìŒì„± ì†ë„ë¥¼ ì„ íƒí•˜ëŠ” í™”ë©´ì…ë‹ˆë‹¤. í™”ë©´ ê°€ìš´ë° ë¶€ë¶„ì„ íƒ­í•  ë•Œë§ˆë‹¤ ì¼ë°°ì†ë¶€í„° ì˜¤ë°°ì†ê¹Œì§€ ì†ë„ë¥¼ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‘ ë²ˆ ë¹ ë¥´ê²Œ íƒ­í•˜ê±°ë‚˜, ì•„ë˜ í™”ë©´ í•˜ë‹¨ì„ í„°ì¹˜í•˜ë©´ ë°°ì†ì´ í™•ì •ë©ë‹ˆë‹¤.",
        speedConfirmed: "ì†ë„ ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤. ì´¬ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.",
        captureReady:
          "ì•Œì•½ì„ í™”ë©´ ì¤‘ì•™ì— ë§ì¶”ê³ , í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ í„°ì¹˜í•˜ë©´ ì´¬ì˜ë©ë‹ˆë‹¤.",
        shutter: "ì°°ì¹µ. ì‚¬ì§„ì„ ì´¬ì˜í–ˆì–´ìš”.",
        loading: "ì•Œì•½ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.",
        needPillFirst:
          "ë¨¼ì € ì•Œì•½ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”. ì§€ê¸ˆ ì´¬ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™í• ê²Œìš”.",
        followupPrompt: "ì¶”ê°€ë¡œ ê¶ê¸ˆí•˜ì‹  ì ì„ ë§ì”€í•´ì£¼ì„¸ìš”.",
        followupProcessing: "ì§ˆë¬¸ì„ ì •ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.",
        followupUnsupported: "ì´ ê¸°ê¸°ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        reset:
          "ì•±ì„ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤. ì†ë„ë¥¼ ì„¤ì •í•œ ë’¤ ì´¬ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.",
        error: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
      });

      const speedOptions = [1.0, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0];
      const speedLabels = [
        "1.0ë°°ì†",
        "1.5ë°°ì†",
        "2.0ë°°ì†",
        "2.5ë°°ì†",
        "3.0ë°°ì†",
        "4.0ë°°ì†",
        "5.0ë°°ì†",
      ];

      const screenElements = document.querySelectorAll(".screen");
      const speedDisplayEl = document.getElementById("speed-text");
      const previewVideo = document.getElementById("camera-preview");
      const loadingStatusEl = document.getElementById("loading-status");
      const resultTextEl = document.getElementById("result-text");
      const resultSubtitleEl = document.getElementById("result-subtitle");
      const resultPillNameEl = document.getElementById("result-pill-name");
      const followupQuestionEl = document.getElementById("followup-question");
      const followupAnswerEl = document.getElementById("followup-answer");
      const followupLayer = document.getElementById("followup-layer");
      const resetButton = document.getElementById("reset-button");
      const toastEl = document.getElementById("toast");
      const screen4El = document.getElementById("screen-4");

      let currentScreen = 1;
      let speedIndex = 0;
      let globalPlaybackRate = speedOptions[speedIndex];

      const audioCache = {};
      let currentAudio = null;
      let recognition = null;
      let stream = null;

      let isCapturing = false;
      let isProcessingFollowup = false;
      let isListeningFollowup = false;

      let lastPillName = "";
      let lastScript = "";
      let lastFollowupQuestion = "";
      let lastFollowupAnswer = "";

      let toastTimer = null;

      function unlockAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
          const ctx = new AudioContext();
          if (ctx.state === "suspended") {
            ctx.resume();
          }
        }
        const audio = new Audio();
        audio.src =
          "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABmYWN0BAAAAAAAAABkYXRhAAAAAA==";
          audio
            .play()
          .then(() => console.log("ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ ì„±ê³µ"))
          .catch((e) => console.log("ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ ëŒ€ê¸° ì¤‘", e));
      }

      function vibrateStrong() {
        if ("vibrate" in navigator) {
          navigator.vibrate(700);
        }
      }

      document
        .getElementById("start-touch-area")
        .addEventListener("click", () => {
          unlockAudio();
          goToScreen(2);
        });

      document
        .getElementById("consent-yes")
        .addEventListener("click", () => {
          vibrateStrong();
          goToScreen(3);
        });

      document
        .getElementById("consent-no")
        .addEventListener("click", () => {
          vibrateStrong();
          handleConsentReject();
        });

      const speedTouchArea = document.getElementById("speed-screen-touch");
      speedTouchArea.addEventListener("click", (event) => {
        if (event.detail === 2) {
          confirmSpeedSelection();
          return;
        }
        cycleSpeed();
      });
      document
        .getElementById("speed-confirm")
        .addEventListener("click", confirmSpeedSelection);

      screen4El.addEventListener("click", (event) => {
        event.stopPropagation();
        vibrateStrong();
        captureAndSend();
      });

      const replayButton = document.getElementById("replay-button");
      const followupButton = document.getElementById("followup-button");

      replayButton.addEventListener("click", async (event) => {
        event.stopPropagation();
        vibrateStrong();
        if (lastScript) {
          await playAudio(lastScript);
        }
      });

      followupButton.addEventListener("click", (event) => {
        event.stopPropagation();
        vibrateStrong();
        handleFollowupTap();
      });

      resetButton.addEventListener("click", (event) => {
        event.stopPropagation();
        vibrateStrong();
        resetApp();
      });

      goToScreen(1);

      function handleConsentReject() {
        goToScreen(1);
        showToast("ë™ì˜ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        playAudio(PROMPTS.consentDenied);
      }

      function goToScreen(screenNumber) {
        currentScreen = screenNumber;
        screenElements.forEach((el) => el.classList.remove("active"));
        const target = document.getElementById(`screen-${screenNumber}`);
        if (target) {
          target.classList.add("active");
        }
        initScreen(screenNumber);
      }

      function initScreen(screenNumber) {
        switch (screenNumber) {
          case 1:
            // ì´ˆê¸° í™”ë©´ì€ ë¬´ìŒìœ¼ë¡œ ì§„ì…
            break;
          case 2:
            playAudio(PROMPTS.consent);
            break;
          case 3:
            updateSpeedDisplay();
            playAudio(PROMPTS.speed);
            break;
          case 4:
            prepareCamera();
            playAudio(PROMPTS.captureReady);
            break;
          case 5:
            // ë¡œë”© í™”ë©´ì€ ë¬´ìŒìœ¼ë¡œ ì§„ì…
            break;
          case 6:
            renderBaseResult();
            break;
          default:
            break;
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => {
            track.stop();
          });
          stream = null;
        }
        if (previewVideo && previewVideo.srcObject) {
          previewVideo.srcObject = null;
        }
      }

      async function prepareCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ì´ ìˆìœ¼ë©´ ì •ë¦¬í•˜ê³  ìƒˆë¡œ ì‹œì‘
        if (stream) {
          stopCamera();
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } },
            audio: false,
          });
        } catch (error) {
          console.warn("í›„ë©´ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨, ì „ë©´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.", error);
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false,
            });
          } catch (fallbackError) {
            alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”: " + fallbackError.message);
            return;
          }
        }
        previewVideo.srcObject = stream;
      }

      function updateSpeedDisplay() {
        speedDisplayEl.textContent = speedLabels[speedIndex];
      }

      function cycleSpeed() {
        speedIndex = (speedIndex + 1) % speedOptions.length;
        globalPlaybackRate = speedOptions[speedIndex];
        updateSpeedDisplay();
        playAudio(`${speedLabels[speedIndex]}ì…ë‹ˆë‹¤.`);
        if (currentAudio) {
          currentAudio.playbackRate = globalPlaybackRate;
        }
      }

      function confirmSpeedSelection() {
        playAudio(PROMPTS.speedConfirmed);
        setTimeout(() => goToScreen(4), 500);
      }

      async function captureAndSend() {
        if (isCapturing) {
          return;
        }
        if (!previewVideo.videoWidth || !previewVideo.videoHeight) {
          showToast("ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          return;
        }
        isCapturing = true;
        goToScreen(5);
        playAudio(PROMPTS.shutter);
        setTimeout(() => playAudio(PROMPTS.loading), 1400);
        try {
          const canvas = document.createElement("canvas");
          canvas.width = previewVideo.videoWidth;
          canvas.height = previewVideo.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(previewVideo, 0, 0, canvas.width, canvas.height);
          const blob = await new Promise((resolve) =>
            canvas.toBlob(resolve, "image/jpeg")
          );
          if (!blob) {
            throw new Error("ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
          const formData = new FormData();
          formData.append("file", blob, "capture.jpg");
          loadingStatusEl.textContent = "ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.";
          const response = await fetch(
            `${API_BASE}/api/v1/pills/identify?session_id=${sessionId}`,
            {
              method: "POST",
              body: formData,
            }
          );
          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.detail || "ì„œë²„ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
          const data = await response.json();
          lastPillName = data.pill_name || "";
          lastScript =
            data.script ||
            "ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•´ ì£¼ì„¸ìš”.";
          lastFollowupQuestion = "";
          lastFollowupAnswer = "";
          renderBaseResult();
          goToScreen(6);
          await playAudio(lastScript);
        } catch (error) {
          console.error(error);
          showToast("ì´¬ì˜ ë˜ëŠ” ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          playAudio(PROMPTS.error);
          goToScreen(4);
        } finally {
          isCapturing = false;
        }
      }

      function renderBaseResult() {
        resultPillNameEl.textContent = lastPillName || "-";
        resultTextEl.innerHTML = formatText(
          lastScript || "ì•„ì§ ë¶„ì„ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."
        );
        resultSubtitleEl.textContent =
          "í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ í„°ì¹˜í•˜ì‹  ë’¤ ë§ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.";
        setFollowupCard(lastFollowupQuestion, lastFollowupAnswer);
      }

      function setFollowupCard(question, answer) {
        followupQuestionEl.innerHTML = question ? formatText(question) : "-";
        followupAnswerEl.innerHTML = answer ? formatText(answer) : "-";
      }

      function renderFollowupListening() {
        resultSubtitleEl.textContent = "ì§€ê¸ˆ ì§ˆë¬¸ì„ ë§ì”€í•´ì£¼ì„¸ìš”.";
        setFollowupCard("-", "ì§ˆë¬¸ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤...");
      }

      function renderFollowupPending(question) {
        resultSubtitleEl.textContent = "AIê°€ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.";
        setFollowupCard(question, "ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
      }

      function renderFollowupAnswer(question, answer) {
        lastFollowupQuestion = question;
        lastFollowupAnswer = answer;
        resultSubtitleEl.textContent =
          "í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ í„°ì¹˜í•˜ì‹  ë’¤ ë§ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.";
        setFollowupCard(question, answer);
      }

      async function handleFollowupTap() {
        if (currentScreen !== 6) {
          return;
        }
        if (!lastPillName) {
          showToast("ë¨¼ì € ì•Œì•½ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”.");
          await playAudio(PROMPTS.needPillFirst);
          goToScreen(4);
          return;
        }
        if (isProcessingFollowup || isListeningFollowup) {
          showToast("í˜„ì¬ ì§ˆë¬¸ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.");
          return;
        }
        if (!canUseSpeechRecognition()) {
          showToast("ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          playAudio(PROMPTS.followupUnsupported);
          return;
        }
        stopAllAudio();
        cancelSpeechRecognition(); // ê¸°ì¡´ ìŒì„± ì¸ì‹ì´ ìˆìœ¼ë©´ ì •ë¦¬
        
        // "ì¶”ê°€ë¡œ ê¶ê¸ˆí•˜ì‹  ì ì„ ë§ì”€í•´ì£¼ì„¸ìš”" ì•ˆë‚´ ìŒì„± ì¬ìƒ í›„ ìŒì„± ì¸ì‹ ì‹œì‘
        await playAudio(PROMPTS.followupPrompt);
        
        // ìŒì„± ì¸ì‹ ì‹œì‘
        startSpeechRecognition({
          onStart: () => {
            isListeningFollowup = true;
            renderFollowupListening();
            showToast("ì§ˆë¬¸ì„ ë§ì”€í•´ì£¼ì„¸ìš”.");
          },
          onResult: async (transcript) => {
            const question = transcript || "";
            if (!question || question.trim().length === 0) {
              showToast("ì§ˆë¬¸ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
              isListeningFollowup = false;
              renderBaseResult();
              return;
            }
            
            isListeningFollowup = false;
            isProcessingFollowup = true;
            renderFollowupPending(question);
            
            try {
              // RAGë¥¼ í™œìš©í•˜ì—¬ ì„œë²„ì— ì§ˆë¬¸ ì „ì†¡ ë° ë‹µë³€ ë°›ê¸°
              const data = await sendFollowup(question);
              
              if (data && data.answer) {
                // ë‹µë³€ì„ í™”ë©´ì— í‘œì‹œ
                renderFollowupAnswer(question, data.answer);
                // ë‹µë³€ì„ ìŒì„±ìœ¼ë¡œ ì¬ìƒ
                await playAudio(data.answer);
              } else {
                showToast("ë‹µë³€ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                playAudio(PROMPTS.error);
                renderBaseResult();
              }
            } catch (error) {
              console.error("ì¶”ê°€ ì§ˆë¬¸ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
              showToast("ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              playAudio(PROMPTS.error);
              renderBaseResult();
            } finally {
              isProcessingFollowup = false;
            }
          },
          onEnd: () => {
            isListeningFollowup = false;
            // ì²˜ë¦¬ ì¤‘ì´ ì•„ë‹ˆë©´ ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ ë³µê·€
            if (!isProcessingFollowup) {
              renderBaseResult();
            }
          },
          onError: (event) => {
            console.error("ìŒì„± ì¸ì‹ ì˜¤ë¥˜:", event);
            isListeningFollowup = false;
            if (!isProcessingFollowup) {
              renderBaseResult();
            }
            showToast("ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
          },
        });
      }

      function canUseSpeechRecognition() {
        return (
          "SpeechRecognition" in window || "webkitSpeechRecognition" in window
        );
      }

      function startSpeechRecognition({
        onStart,
        onResult,
        onEnd,
        onError,
      }) {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          return;
        }
        if (recognition) {
          try {
          recognition.abort();
          } catch (error) {
            console.warn("ê¸°ì¡´ ìŒì„± ì¸ì‹ì„ ì¤‘ë‹¨í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", error);
        }
        }
        recognition = new SpeechRecognition();
        recognition.lang = "ko-KR";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onstart = () => onStart?.();
        recognition.onend = () => onEnd?.();
        recognition.onerror = (event) => onError?.(event);
        recognition.onresult = async (event) => {
          const transcript = (event.results[0][0].transcript || "").trim();
          await onResult?.(transcript);
        };
        try {
        recognition.start();
        } catch (error) {
          console.warn("ìŒì„± ì¸ì‹ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", error);
          onError?.(error);
        }
      }

      function cancelSpeechRecognition() {
        if (!recognition) {
          return;
        }
        try {
          recognition.onstart = null;
          recognition.onresult = null;
          recognition.onend = null;
          recognition.onerror = null;
          recognition.abort();
        } catch (error) {
          console.warn("ìŒì„± ì¸ì‹ì„ ì¤‘ë‹¨í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", error);
        } finally {
          recognition = null;
        }
      }

      async function sendFollowup(question) {
        try {
          const response = await fetch(`${API_BASE}/api/v1/pills/followup`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              session_id: sessionId,
              question,
            }),
          });
          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.detail || "ì¶”ê°€ ì§ˆë¬¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
          const data = await response.json();
          lastPillName = data.pill_name || lastPillName;
          renderFollowupAnswer(question, data.answer || "");
          return data;
        } catch (error) {
          console.error(error);
          showToast("ì¶”ê°€ ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          playAudio(PROMPTS.error);
          renderBaseResult();
          return null;
        }
      }

      function resetApp() {
        stopAllAudio();
        cancelSpeechRecognition();
        stopCamera(); // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
        isProcessingFollowup = false;
        isListeningFollowup = false;
        isCapturing = false; // ì´¬ì˜ ìƒíƒœë„ ì´ˆê¸°í™”
        lastPillName = "";
        lastScript = "";
        lastFollowupQuestion = "";
        lastFollowupAnswer = "";
        goToScreen(4);
        // initScreen(4)ì—ì„œ prepareCamera()ì™€ playAudio(PROMPTS.captureReady)ë¥¼ ìë™ìœ¼ë¡œ í˜¸ì¶œ
      }

      function showToast(message, duration = 2000) {
        if (!toastEl) {
          return;
        }
        toastEl.textContent = message;
        toastEl.classList.add("show");
        if (toastTimer) {
          clearTimeout(toastTimer);
        }
        toastTimer = setTimeout(() => {
          toastEl.classList.remove("show");
        }, duration);
      }

      function formatText(text = "") {
        return escapeHtml(text).replace(/\n/g, "<br />");
      }

      function escapeHtml(text = "") {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function stopAudio() {
        if (!currentAudio) {
          return;
        }
        try {
          currentAudio.pause();
          currentAudio.currentTime = 0;
        } catch (error) {
          console.warn("ì˜¤ë””ì˜¤ ì¤‘ë‹¨ ì‹¤íŒ¨", error);
        }
        currentAudio = null;
      }

      function stopAllAudio() {
        stopAudio();
      }

      async function playAudio(text) {
        const normalized = (text || "").trim();
        if (!normalized) {
          return;
        }
        try {
          stopAudio();
          const audioBase64 = await getAudioBase64(normalized);
          await playBase64Audio(audioBase64);
        } catch (error) {
          console.warn("ìŒì„± ì¬ìƒ ì‹¤íŒ¨", error);
          showToast("ìŒì„±ì„ ì¬ìƒí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
      }

      async function getAudioBase64(text) {
        if (audioCache[text]) {
          return audioCache[text];
        }
        const response = await fetch(`${API_BASE}/api/v1/tts`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.detail || "TTS ìš”ì²­ ì‹¤íŒ¨");
        }
        const data = await response.json();
        if (!data?.audio_base64) {
          throw new Error("TTS ì‘ë‹µì— ì˜¤ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
        audioCache[text] = data.audio_base64;
        return data.audio_base64;
      }

      function playBase64Audio(base64) {
        return new Promise((resolve) => {
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }
          const audio = new Audio(`data:audio/mp3;base64,${base64}`);
          audio.playbackRate = globalPlaybackRate;
          audio.muted = true;
          const playPromise = audio.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                setTimeout(() => {
                  audio.muted = false;
                }, 100);
                currentAudio = audio;
              })
              .catch((error) => {
                console.warn("ìë™ ì¬ìƒ ë§‰í˜, ì‚¬ìš©ì í„°ì¹˜ í•„ìš”", error);
                resolve();
              });
          }
          audio.onended = () => {
            if (currentAudio === audio) currentAudio = null;
            resolve();
          };
          audio.onerror = (event) => {
            console.error("ì˜¤ë””ì˜¤ ì—ëŸ¬", event);
            if (currentAudio === audio) currentAudio = null;
            resolve();
          };
        });
      }
    </script>
  </body>
</html>

